name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      (github.event_name == 'pull_request') || 
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request && 
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR diff
        id: pr-diff
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff origin/${{ github.base_ref }}...${{ github.sha }} > pr-diff.txt
          else
            # For issue comments, fetch the PR branch
            PR_NUMBER=$(jq -r .issue.number "$GITHUB_EVENT_PATH")
            gh pr checkout $PR_NUMBER
            git diff origin/${{ github.event.repository.default_branch }}...HEAD > pr-diff.txt
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Review with Claude
        id: claude-review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Check if API key is set
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: ANTHROPIC_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" > claude-review.md
            exit 0
          fi
          
          # Read the diff file
          DIFF_CONTENT=$(cat pr-diff.txt)
          
          # Create the prompt with proper escaping
          PROMPT="ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å·®åˆ†ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€å»ºè¨­çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ—¥æœ¬èªã§æä¾›ã—ã¦ãã ã•ã„ã€‚

          ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¦³ç‚¹:
          - ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
          - æ½œåœ¨çš„ãªãƒã‚°ã‚„å•é¡Œ
          - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®è€ƒæ…®äº‹é …
          - TypeScriptã®å‹å®‰å…¨æ€§
          - Reactã¨Next.jsã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
          - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®æ‡¸å¿µäº‹é …
          
          ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:
          - Next.js 15ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆTypeScriptä½¿ç”¨ï¼‰
          - Tailwind CSSã¨Shadcn/uiã‚’ä½¿ç”¨
          - Word/Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã®POC
          
          ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®å·®åˆ†:
          $DIFF_CONTENT"
          
          # Escape the prompt for JSON
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)
          
          # Create the JSON payload
          JSON_PAYLOAD=$(jq -n \
            --arg model "claude-3-5-sonnet-20241022" \
            --argjson max_tokens 4096 \
            --argjson temperature 0.7 \
            --argjson prompt "$ESCAPED_PROMPT" \
            '{
              model: $model,
              max_tokens: $max_tokens,
              temperature: $temperature,
              messages: [{
                role: "user",
                content: $prompt
              }]
            }')
          
          # Call Claude API with better error handling
          RESPONSE=$(curl -s -w "\n\nHTTP_STATUS:%{http_code}" -X POST https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$JSON_PAYLOAD")
          
          # Extract HTTP status code
          HTTP_STATUS=$(echo "$RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
          
          echo "API Response Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ]; then
            # Extract the review text
            REVIEW=$(echo "$BODY" | jq -r '.content[0].text // "ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"')
            echo "$REVIEW" > claude-review.md
          else
            # Log error details
            echo "API Error Response:"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            
            # Create error message
            ERROR_MSG="ã‚¨ãƒ©ãƒ¼: Claude APIãŒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ $HTTP_STATUS ã‚’è¿”ã—ã¾ã—ãŸ"
            if [ "$HTTP_STATUS" = "401" ]; then
              ERROR_MSG="$ERROR_MSG - ãƒªãƒã‚¸ãƒˆãƒªã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ANTHROPIC_API_KEYãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„"
            elif [ "$HTTP_STATUS" = "429" ]; then
              ERROR_MSG="$ERROR_MSG - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è¶…éã—ã¾ã—ãŸ"
            fi
            
            echo "$ERROR_MSG" > claude-review.md
          fi
      
      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('claude-review.md', 'utf8');
            
            const comment = `## ğŸ¤– Claude PRãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n${review}\n\n---\n*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Claude AIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*`;
            
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            } else if (context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }