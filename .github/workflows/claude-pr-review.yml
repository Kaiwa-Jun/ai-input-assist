name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      (github.event_name == 'pull_request') || 
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request && 
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR diff
        id: pr-diff
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff origin/${{ github.base_ref }}...${{ github.sha }} > pr-diff.txt
          else
            # For issue comments, fetch the PR branch
            PR_NUMBER=$(jq -r .issue.number "$GITHUB_EVENT_PATH")
            gh pr checkout $PR_NUMBER
            git diff origin/${{ github.event.repository.default_branch }}...HEAD > pr-diff.txt
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Review with Claude
        id: claude-review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create review prompt
          PROMPT="Please review this pull request diff and provide constructive feedback.
          
          Focus on:
          - Code quality and best practices
          - Potential bugs or issues
          - Performance considerations
          - TypeScript type safety
          - React and Next.js best practices
          - Accessibility concerns
          
          Project context:
          - This is a Next.js 15 application with TypeScript
          - Uses Tailwind CSS and Shadcn/ui
          - POC for AI-assisted form filling from Word/Excel files
          
          Diff to review:
          $(cat pr-diff.txt)"
          
          # Call Claude API
          REVIEW=$(curl -X POST https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "{
              \"model\": \"claude-3-5-sonnet-20241022\",
              \"max_tokens\": 4096,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": \"$PROMPT\"
              }],
              \"temperature\": 0.7
            }" | jq -r '.content[0].text')
          
          # Save review for next step
          echo "$REVIEW" > claude-review.md
      
      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('claude-review.md', 'utf8');
            
            const comment = `## ðŸ¤– Claude PR Review\n\n${review}\n\n---\n*This review was automatically generated by Claude AI.*`;
            
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            } else if (context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }